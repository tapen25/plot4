<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>身体と音楽の協奏プロトタイプ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* スライダーの見た目をカスタマイズ */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen font-sans">
    <div id="startScreen" class="absolute inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-20">
        <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg transform hover:scale-105 transition-transform">
            体験を開始する
        </button>
    </div>

    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <div class="text-center">
            <h1 class="text-2xl font-bold text-white">身体と音楽の協奏</h1>
            <p class="text-gray-400 mt-1">あなたの身体が、音楽を奏でる</p>
        </div>

        <!--  -->
        
        <!-- 状態表示パネル -->
        <div class="bg-gray-700 rounded-xl p-4 grid grid-cols-2 gap-4 text-center">
            <div>
                <p class="text-sm text-gray-400">指揮: 歩行ペース (SPM)</p>
                <p id="spmDisplay" class="text-3xl font-bold text-cyan-400">80</p>
                <p class="text-sm text-gray-400 mt-2">♪ 音楽テンポ (BPM)</p>
                <p id="bpmDisplay" class="text-lg font-semibold text-cyan-300">80</p>
            </div>
            <div>
                <p class="text-sm text-gray-400">感情: 心拍数 (HR)</p>
                <p id="hrDisplay" class="text-3xl font-bold text-rose-400">70</p>
                <p class="text-sm text-gray-400 mt-2">♪ 音色</p>
                <p id="timbreDisplay" class="text-lg font-semibold text-rose-300">穏やか</p>
            </div>
        </div>

        <!-- 操作パネル -->
        <div class="pt-4 space-y-6">
            <div>
                <label for="spmSlider" class="text-lg font-semibold flex items-center justify-between">
                    <span>🚶‍♂️ 歩行ペース</span>
                    <span class="text-sm text-gray-400">(ゆっくり ↔ はやく)</span>
                </label>
                <input id="spmSlider" type="range" min="40" max="180" value="80" class="w-full h-3 bg-gray-600 rounded-lg appearance-none cursor-pointer mt-2 accent-cyan-400">
            </div>
            <div>
                <label for="hrSlider" class="text-lg font-semibold flex items-center justify-between">
                    <span>❤️ 心拍数</span>
                     <span class="text-sm text-gray-400">(リラックス ↔ 興奮)</span>
                </label>
                <input id="hrSlider" type="range" min="60" max="160" value="70" class="w-full h-3 bg-gray-600 rounded-lg appearance-none cursor-pointer mt-2 accent-rose-400">
            </div>
        </div>
        
    </div>

    <script>
        // --- DOM要素 ---
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const spmDisplay = document.getElementById('spmDisplay');
        const bpmDisplay = document.getElementById('bpmDisplay');
        const hrDisplay = document.getElementById('hrDisplay');
        const timbreDisplay = document.getElementById('timbreDisplay');
        const spmSlider = document.getElementById('spmSlider');
        const hrSlider = document.getElementById('hrSlider');

        // --- 音楽エンジン (Tone.js) ---
        // フィルター: 音の「鋭さ」をコントロール
        const filter = new Tone.AutoFilter('4n').toDestination().start();
        filter.depth.value = 0.8;
        // シンセサイザー: 音の「元」となる部分
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: 'triangle' }, // 三角波からスタート
            envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
        }).connect(filter);
        synth.volume.value = -8;

        // 簡単なアルペジオ（分散和音）パターンを定義
        const pattern = new Tone.Pattern((time, note) => {
            synth.triggerAttackRelease(note, '8n', time);
        }, ['C3', 'E3', 'G3', 'B3', 'C4', 'B3', 'G3', 'E3'], 'up');
        pattern.interval = '8n';

        // --- アプリケーションの状態 ---
        let currentSpm = 80;
        let currentHr = 70;

        // --- メイン更新関数 ---
        function updateMusicAndUI() {
            // 1. UIを更新
            spmDisplay.textContent = currentSpm;
            hrDisplay.textContent = currentHr;
            bpmDisplay.textContent = currentSpm; // SPMをBPMに直接反映

            // 2. 音楽のテンポを更新 (滑らかに変化させる)
            Tone.Transport.bpm.rampTo(currentSpm, 0.5);

            // 3. 心拍数に応じて音色を更新
            // 心拍数が低い(60) -> 穏やか, 心拍数が高い(160) -> 鋭い
            const hrNormalized = (currentHr - 60) / 100; // 0.0 ~ 1.0 の範囲に正規化

            // a. 波形を変化させる
            if (currentHr < 90) {
                synth.set({ oscillator: { type: 'sine' } });
                timbreDisplay.textContent = '穏やか';
            } else if (currentHr < 130) {
                synth.set({ oscillator: { type: 'triangle' } });
                timbreDisplay.textContent = 'クリア';
            } else {
                synth.set({ oscillator: { type: 'sawtooth' } });
                timbreDisplay.textContent = '鋭い';
            }
            
            // b. フィルターの周波数を変化させる (高いほど明るく鋭い音に)
            // 200Hz (こもった音) から 5000Hz (開いた音) の範囲で変化
            const filterFreq = 200 + hrNormalized * 4800;
            filter.baseFrequency = filterFreq;
        }

        // --- イベントリスナー ---
        spmSlider.addEventListener('input', (event) => {
            currentSpm = parseInt(event.target.value);
            updateMusicAndUI();
        });

        hrSlider.addEventListener('input', (event) => {
            currentHr = parseInt(event.target.value);
            updateMusicAndUI();
        });

        startButton.addEventListener('click', () => {
            // ユーザー操作をきっかけにオーディオを開始
            Tone.start();
            Tone.Transport.start();
            pattern.start(0);
            
            console.log('音楽体験を開始します');
            startScreen.style.display = 'none';
            // 初期値を反映
            updateMusicAndUI();
        });
    </script>
</body>
</html>
